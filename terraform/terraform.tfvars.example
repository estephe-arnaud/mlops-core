# ============================================================================
# Configuration Terraform pour MLOps Core
# ============================================================================
# 
# INSTRUCTIONS :
# 1. Copier vers terraform.tfvars : cp terraform.tfvars.example terraform.tfvars
# 2. Remplir les valeurs obligatoires (marquées ⚠️)
# 3. ⚠️ Ne jamais commiter terraform.tfvars (contient des secrets)
#
# ============================================================================

# ============================================================================
# ⚠️ CONFIGURATION OBLIGATOIRE
# ============================================================================

# ID du projet GCP
project_id = "your-project-id"

# ============================================================================
# CONFIGURATION RÉSEAU - SÉCURITÉ CRITIQUE
# ============================================================================
#
# ⚠️ IMPORTANT : Deux scénarios de sécurité possibles
#
# SCÉNARIO 1 : Load Balancer (RECOMMANDÉ en production)
#   - enable_load_balancer = true
#   - enable_public_ip = false
#   - Accès HTTP : Via Load Balancer (IP publique du LB, protégé par Cloud Armor)
#   - Accès SSH : Via IAP uniquement (pas d'IP publique sur la VM)
#   - allowed_http_ips : Plages IP des Load Balancers GCP (pour autoriser LB → VM)
#   - allowed_ssh_ips : Vide (SSH via IAP uniquement)
#
# SCÉNARIO 2 : IP publique sur la VM (moins sécurisé, pour tests/dev)
#   - enable_load_balancer = false
#   - enable_public_ip = true
#   - Accès HTTP : Directement à l'IP publique de la VM (ports 80, 8000)
#   - Accès SSH : Directement à l'IP publique de la VM (port 22)
#   - allowed_http_ips : Votre IP uniquement (ex: ["123.45.67.89/32"])
#   - allowed_ssh_ips : Votre IP uniquement (ex: ["123.45.67.89/32"])
#   ⚠️ SÉCURITÉ : Seules les IPs dans ces listes peuvent accéder à la VM
#
# ============================================================================

# IPs autorisées pour SSH (si enable_public_ip = true)
# Pour connaître votre IP publique : curl https://checkip.amazonaws.com
# ⚠️ Si vous utilisez uniquement IAP (enable_public_ip = false), cette liste peut rester vide
allowed_ssh_ips = [
  "VOTRE-IP-PUBLIQUE/32",  # Exemple : "123.45.67.89/32"
]

# Utilisateurs autorisés pour SSH via IAP (sécurité supplémentaire même avec IP publique)
# ⚠️ SÉCURITÉ : Configurez avec les emails des utilisateurs autorisés
# ⚠️ OBLIGATOIRE : Même avec IP publique, IAP ajoute une couche de sécurité
iap_tunnel_users = [
  "user@example.com",  # Exemple : votre email GCP
]

# IPs autorisées pour HTTP/HTTPS
# Option 1 : Si vous utilisez un Load Balancer GCP (RECOMMANDÉ)
#   → Ces plages IP autorisent le trafic du Load Balancer vers la VM
allowed_http_ips = [
  "130.211.0.0/22",  # Plages IP des Load Balancers GCP (globales)
  "35.191.0.0/16",
]

# Option 2 : Si vous exposez directement la VM (NON RECOMMANDÉ en production)
#   → Votre IP uniquement pour accéder directement à l'API
# allowed_http_ips = [
#   "123.45.67.89/32",  # Votre IP uniquement
# ]

# Image Docker (URI complète depuis Artifact Registry)
docker_image = "europe-west1-docker.pkg.dev/YOUR_PROJECT_ID/mlops-repo/iris-api:latest"

# ============================================================================
# SECRET MANAGER - API Key
# ============================================================================

# Option A : Création via Terraform (recommandé)
# 1. Exporter : export TF_VAR_api_key_value="votre-api-key"
# 2. Configurer :
create_secret_manager_secret = true
secret_manager_api_key_name  = "mlops-api-key"

# Option B : Secret créé manuellement
# create_secret_manager_secret = false
# secret_manager_api_key_name  = "mlops-api-key"

# ============================================================================
# CONFIGURATION OPTIONNELLE
# ============================================================================

# Région et zone GCP
region = "europe-west1"
zone   = "europe-west1-b"

# Nom du bucket (vide = généré automatiquement : {project_id}-ml-models)
bucket_name = ""

# URI MLflow Tracking
# - Laisser vide pour utiliser automatiquement le bucket GCS créé par Terraform
#   comme base d'artefacts MLflow (gs://{bucket_name}/mlruns/) dans le conteneur.
#   Dans ce cas, le modèle est chargé directement depuis GCS.
# - Pour un serveur MLflow distant, mettre une URL supportée (http(s)://, postgres://, mysql://, sqlite://, ...).
# - ⚠️ Ne pas utiliser directement un URI gs:// comme *tracking backend* (registry) côté MLflow :
#   dans ce projet, les URI gs:// sont traitées comme base d'artefacts uniquement, pas comme registry.
mlflow_tracking_uri = ""

# Origines CORS (liste d'origines séparées par des virgules)
# - Développement local : vous pouvez utiliser des origines comme "http://localhost:3000".
# - Production : NE PAS utiliser "*" (joker) ni laisser vide.
#   En mode production, l'application refusera de démarrer si CORS_ORIGINS contient "*" ou est vide.
#   Exemple : "https://mon-front.com" ou "http://localhost:3000".
cors_origins = "http://localhost"

# Note: Le service est configuré et activé (démarrage au boot), mais non démarré automatiquement
# Démarrer l'API après déploiement: systemctl start mlops-api

# ============================================================================
# CONFIGURATION AVANCÉE (valeurs par défaut généralement suffisantes)
# ============================================================================

# VM
vm_name      = "iris-api-server"
machine_type = "e2-micro"  # e2-micro (free tier) → e2-standard-2 (production)
vm_image     = "ubuntu-os-cloud/ubuntu-2204-lts"
disk_size_gb = 10

# Réseau
network_name          = "mlops-vpc"
service_account_name  = "mlops-api-sa"
enable_public_ip      = false  # Recommandé avec Load Balancer

# Bucket
force_destroy_bucket = false  # ⚠️ SÉCURITÉ : Protège les données

# Monitoring
enable_monitoring_alerts = true
notification_channels    = []  # Exemple : ["email:admin@example.com"]

# Load Balancer (optionnel, recommandé en production)
enable_load_balancer = true
load_balancer_name  = "mlops-api-lb"
enable_cloud_armor  = true  # Nécessite enable_load_balancer = true

# KMS Chiffrement (optionnel)
enable_kms_encryption = false
# kms_key_name = "projects/PROJECT/locations/LOCATION/keyRings/RING/cryptoKeys/KEY"

# Tags
tags = {
  project     = "mlops"
  environment = "dev"  # dev, staging, production
  managed_by  = "terraform"
}
