# Network Policy pour limiter le trafic réseau (sécurité)
# ⚠️ Nécessite un CNI qui supporte Network Policies (Calico, Cilium, etc.)
# En production, implémentez des règles restrictives pour limiter l'accès

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: iris-api-network-policy
  namespace: mlops
  labels:
    app: iris-api
    component: network-policy
spec:
  podSelector:
    matchLabels:
      app: iris-api
  
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Autoriser le trafic depuis le Service ClusterIP
  - from:
    - namespaceSelector:
        matchLabels:
          name: mlops
    ports:
    - protocol: TCP
      port: 8000
  
  # Autoriser le trafic depuis l'Ingress Controller (si présent)
  # ⚠️ SÉCURITÉ : Adaptez le namespaceSelector selon votre installation Ingress
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx  # Adaptez selon votre installation
      podSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8000
  
  # Autoriser les health checks depuis kubelet
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 8000
  
  egress:
  # Autoriser le trafic DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  
  # Autoriser l'accès à GCS pour MLflow (si nécessaire)
  # Note: Pour GCS, vous devrez peut-être utiliser un proxy ou autoriser toutes les connexions HTTPS sortantes
  - to: []
    ports:
    - protocol: TCP
      port: 443  # HTTPS pour GCS

