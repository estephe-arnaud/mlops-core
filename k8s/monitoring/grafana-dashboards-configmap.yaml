# Dashboards Grafana : Visualisation des métriques
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: mlops
  labels:
    app: grafana
    component: monitoring
data:
  # Dashboard principal : Vue d'ensemble API Iris
  iris-api-overview.json: |
    {
      "dashboard": {
        "title": "Iris API - Overview",
        "tags": ["mlops", "iris-api"],
        "timezone": "browser",
        "schemaVersion": 27,
        "version": 1,
        "refresh": "30s",
        "panels": [
          {
            "id": 1,
            "title": "Model Predictions Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "rate(model_predictions_total[5m])",
                "legendFormat": "{{predicted_class}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "reqps", "label": "Predictions/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 2,
            "title": "Model Confidence Distribution",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(model_confidence_bucket[5m]))",
                "legendFormat": "p95",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.50, rate(model_confidence_bucket[5m]))",
                "legendFormat": "p50",
                "refId": "B"
              }
            ],
            "yaxes": [
              {"format": "percentunit", "min": 0, "max": 1},
              {"format": "short"}
            ]
          },
          {
            "id": 3,
            "title": "API Errors Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
            "targets": [
              {
                "expr": "rate(api_errors_total[5m])",
                "legendFormat": "{{error_type}} - {{endpoint}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "reqps", "label": "Errors/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 4,
            "title": "Model Loaded Status",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 8},
            "targets": [
              {
                "expr": "model_loaded",
                "refId": "A"
              }
            ],
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto"
            },
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 1, "color": "green"}
                  ]
                }
              }
            }
          },
          {
            "id": 5,
            "title": "Total Predictions",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 8},
            "targets": [
              {
                "expr": "sum(model_predictions_total)",
                "refId": "A"
              }
            ],
            "options": {
              "colorMode": "value",
              "graphMode": "area"
            }
          }
        ]
      }
    }
  # Dashboard Kubernetes : Métriques infrastructure
  kubernetes-overview.json: |
    {
      "dashboard": {
        "title": "Kubernetes - Infrastructure",
        "tags": ["kubernetes", "infrastructure"],
        "timezone": "browser",
        "schemaVersion": 27,
        "version": 1,
        "refresh": "30s",
        "panels": [
          {
            "id": 1,
            "title": "CPU Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total[5m]) * 100",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "percent", "label": "CPU %"},
              {"format": "short"}
            ]
          },
          {
            "id": 2,
            "title": "Memory Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "container_memory_usage_bytes / 1024 / 1024",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "mbytes", "label": "Memory (MB)"},
              {"format": "short"}
            ]
          },
          {
            "id": 3,
            "title": "Pod Status",
            "type": "table",
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8},
            "targets": [
              {
                "expr": "kube_pod_status_phase",
                "refId": "A"
              }
            ]
          }
        ]
      }
    }
